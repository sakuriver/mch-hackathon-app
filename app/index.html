<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Mch Tool</title>
    <link rel="stylesheet" href="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/themes/smoothness/jquery-ui.css">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.2.1/css/bootstrap.min.css">
    <script src="https://cdn.jsdelivr.net/gh/ethereum/web3.js/dist/web3.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.3.1.min.js"
            integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="
            crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-cookie/1.4.1/jquery.cookie.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.8.2/moment.min.js"></script>
    <script src="./js/extension_asset_abi.js"></script>
    <script src="./js/hero_asset_abi.js"></script>
    <script src="./js/land_sector_asset_abi.js"></script>
    <script src="./js/mch_meta_marking_abi.js"></script>
    <script src="./js/app_config.js"></script>
    <script src="./js/land_logic.js"></script>
    <script src="./js/network.js"></script>
  </head>
  <body>
    <div class="container my-5">
      <h1>ランドメンバーのヒーロー展示場</h1>
      <div> 
        <h3>ランド名</h3>
        <div id="land-name"></div>
        <h3>メンバーリスト</h3>
        <div id="user-result">
        </div>    
        <h3>メンバー毎のヒーロー一覧</h3>
        <div id="hero-result">
        </div>
      </div>  
    </div>

    <script>
        let web3js;
        let extensionAsset;
        let heroAsset;
        let landSectorAsset;
        let mchMetaMarking;

        // エクステンションコントラクトを取得する
        function getExtensionAssetContract() {
            const abi = extensionAssetAbi;
            // Todo : abiはサーバーとアドレスはサーバーから取得できるようにするのが自然かと思われる
            const contractAddress = extensionAssetAddress;
            const contract = web3js.eth.contract(abi).at(contractAddress);
            return contract;
        }


        function getHeroAssetContract() {
            const abi = heroAssetAbi;
            // Todo : abiはサーバーとアドレスはサーバーから取得できるようにするのが自然かと思われる
            const contractAddress = heroAssetAddress;
            const contract = web3js.eth.contract(abi).at(contractAddress);
            return contract;
        }

        function getLandSectorAssetContract() {
            const abi = landSectorAssetAbi;
            // Todo : abiはサーバーとアドレスはサーバーから取得できるようにするのが自然かと思われる
            const contractAddress = landSectorAssetAddress;
            const contract = web3js.eth.contract(abi).at(contractAddress);
            return contract;
        }

        function getMchMetaMarkingContract() {
            const abi = mchMetaMarkingAbi;
            // Todo : abiはサーバーとアドレスはサーバーから取得できるようにするのが自然かと思われる
            const contractAddress = mchMetaMarkingAddress;
            const contract = web3js.eth.contract(abi).at(contractAddress);
            return contract;
        }


        function startApp() {
            console.log("app start");

            // ユーザーアカウントの取得
            web3js.eth.getAccounts(function(error, accounts) {
                if (error) {
                    console.log(error);
                } else {
                    console.log("accounts complete");
                }
               // userAccount = accounts[0];
               // $("#login-address").text(userAccount);
              // contractのxxxxを叩いて動作確認
              extensionAsset = getExtensionAssetContract();
              heroAsset = getHeroAssetContract();
              landSectorAsset = getLandSectorAssetContract();
              mchMetaMarking = getMchMetaMarkingContract();
              $("#user-result").empty();
              $("#hero-result").empty();
              landType = $.cookie("landType");
              landSince = $.cookie("landSince");
              if (typeof landType === 'undefined')  {
                  $("#land-name").html("Zentrale");
              } else {
                  $("#land-name").html(getLandNameByLandType(landType));
              }
              getUserListFromLand(landType, landSince);
              console.log(heroAsset.methods);
              console.log(heroAsset.tokenURI);
            });
            console.log("app end");

        }
        function getUserListFromLand(landType, landSince) {
            mchMetaMarking.getAddressesByLandType(landType, landSince, (err, result) =>{
                console.log(err);
                console.log(result);
                for (var i = 0; i < result.length;  i++) {
                    createUserResult(result[i]);
                    getHeroListFromOwnerAddress(result[i]);
                }
            });
        }
        function getHeroListFromOwnerAddress(ownerAddress) {
            heroAsset.balanceOf(ownerAddress, (err, result) =>{
                console.log(err);
                console.log(result);
                for (var i = 0; i < result.c[0];  i++) {
                  heroAsset.tokenOfOwnerByIndex(ownerAddress, i, (err, result) => {
                      getTokenData(result.c[0]);
                  });
                }
            });
        }        


        function createUserResult(ethAddress) {
            userProfileUrl = sideChainEndPointUrl + "users/" + ethAddress;
            var getDataCallBack = function (data, textStatus, jqXHR) {
                if (typeof data === 'undefined') {
                    //
                    loginCheckError();
                    return
                } else {
                   console.log(data);
                    divString = '<div id="box_' + data.uid + '" class="card bg-primary text-white my-1">';
                    divString += '<div class="card-body">' +"#"  + data.uid + ":" + data.name + '</div>';
                    divString += '</div>';
                    console.log(divString);
                    var div = $(divString);
                    $("#user-result").append(div);
                   // 入力情報が一致しているかを確認する
                }
            };
            var getDataFailCallBack = function (data, textStatus, jqXHR) {
                loginCheckError();
                return;
            };            
            connectServerGetMethod(userProfileUrl, getDataCallBack, getDataFailCallBack);
        }        

        function getTokenData(tokenId) {
            tokenUri = "https://www.mycryptoheroes.net/metadata/hero/" + tokenId;
            var getDataCallBack = function (data, textStatus, jqXHR) {
                if (typeof data === 'undefined') {
                    //
                    loginCheckError();
                    return
                } else {
                   if (typeof data !== 'undefined') {
                        divString = '<div id="token-data-' + data.attributes.id + '"" class="card bg-primary text-white my-1"><div>名前:';
                        divString += data.name + '</div>';
                        divString += '<div>説明文:' + data.description + '</div>';
                        divString += '<div>lv :' + data.attributes.lv + '</div>';
                        divString += '<img  src="' + data.image + '" width="80" height="80"/>' + '</div>';
                        console.log(divString);
                        var div = $(divString);
                        $("#hero-result").append(div);
                    }
                }
            };
            var getDataFailCallBack = function (data, textStatus, jqXHR) {
                loginCheckError();
                return;
            };                   
            data = connectServerGetMethod(tokenUri, getDataCallBack, getDataFailCallBack);                
        }


        // サイドチェーンから、プロフィール情報を取得する
        function getUserProfileData(ethAddress) {
            userProfileUrl = sideChainEndPointUrl + "users/" + ethAddress;
            console.log(userProfileUrl);
            connectServerGetMethod(userProfileUrl, getDataCallBack);
        }

        var getDataCallBack = function (data, textStatus, jqXHR) {
            console.log(data);
            return data;
        }


        window.addEventListener('load', function() {
            if (typeof web3 !== 'undefined') {
                web3 = new Web3(web3.currentProvider);
            } else {
                // set the provider you want from Web3.providers
                console.log(mchMetaMarkingAddress);
                web3 = new Web3(new Web3.providers.HttpProvider(ethNetWorkUrl));
            }
            console.log('web3: ', web3);
            if (web3) {
                web3js = web3;
            }
            console.log('web3js: ', web3js);

            startApp();
        });       
    </script>
  </body>
</html>
